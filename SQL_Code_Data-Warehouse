##  dim_crime_type table

CREATE TABLE dim_crime_type (
    crime_type_id INT PRIMARY KEY,
    crime_type    VARCHAR(100) NOT NULL
);

INSERT INTO dim_crime_type (crime_type_id, crime_type)
SELECT
    ROW_NUMBER() OVER (ORDER BY crime_type) AS crime_type_id,
    crime_type
FROM (
    SELECT DISTINCT crime_type
    FROM crime_df
    WHERE crime_type IS NOT NULL
) t;

## dim_lsoaname table

CREATE TABLE dim_lsoaname (
    lsoa_id   INT PRIMARY KEY,
    lsoa_name VARCHAR(100) NOT NULL,
    lsoa_code VARCHAR(50)
);

INSERT INTO dim_lsoaname (lsoa_id, lsoa_name, lsoa_code)
SELECT
    ROW_NUMBER() OVER (ORDER BY lsoa_name) AS lsoa_id,
    lsoa_name,
    lsoa_code
FROM (
    SELECT DISTINCT lsoa_name, lsoa_code
    FROM crime_df
    WHERE lsoa_name IS NOT NULL
) t;


##  dim_location table

CREATE TABLE dim_location (
    location_id INT PRIMARY KEY,
    location    VARCHAR(100)
);

INSERT INTO dim_location (location_id, location)
SELECT
    ROW_NUMBER() OVER (ORDER BY location) AS location_id,
    location
FROM (
    SELECT DISTINCT location
    FROM crime_df
) t;


## dim_outcome table

CREATE TABLE dim_outcome (
    outcome_id            INT PRIMARY KEY,
    last_outcome_category VARCHAR(200)
);

INSERT INTO dim_outcome (outcome_id, last_outcome_category)
SELECT
    ROW_NUMBER() OVER (ORDER BY last_outcome_category) AS outcome_id,
    last_outcome_category
FROM (
    SELECT DISTINCT last_outcome_category
    FROM crime_df
    WHERE last_outcome_category IS NOT NULL
) t;

## dim_date table

CREATE TABLE dim_date (
    date_id      INT PRIMARY KEY,  
    full_date    DATE NOT NULL,
    day_of_week  VARCHAR(10),
    day_of_month INT,
    day_of_year  INT,
    week_of_year INT,
    month_name   VARCHAR(20),
    month_number INT,
    quarter      INT,
    year         INT,
    year_month   VARCHAR(7)    -- 'YYYY-MM'
);

WITH RECURSIVE dates AS (
    SELECT DATE '2000-01-01' AS full_date
    UNION ALL
    SELECT full_date + INTERVAL '1 day'
    FROM dates
    WHERE full_date < DATE '2050-12-31'
)
INSERT INTO dim_date (
    date_id,
    full_date,
    day_of_week,
    day_of_month,
    day_of_year,
    week_of_year,
    month_name,
    month_number,
    quarter,
    year,
    year_month
)
SELECT
    TO_CHAR(full_date, 'YYYYMMDD')::INT AS date_id,
    full_date,
    TO_CHAR(full_date, 'Day')           AS day_of_week,
    EXTRACT(DAY FROM full_date)::INT    AS day_of_month,
    EXTRACT(DOY FROM full_date)::INT    AS day_of_year,
    EXTRACT(WEEK FROM full_date)::INT   AS week_of_year,
    TO_CHAR(full_date, 'Month')         AS month_name,
    EXTRACT(MONTH FROM full_date)::INT  AS month_number,
    EXTRACT(QUARTER FROM full_date)::INT AS quarter,
    EXTRACT(YEAR FROM full_date)::INT   AS year,
    TO_CHAR(full_date, 'YYYY-MM')       AS year_month
FROM dates
ORDER BY full_date;



## fact_crime_num

CREATE TABLE fact_crime_num (
    date_id                 INT,
    year                    INT,
    month_number            INT,
    lsoa_id                 INT,
    lsoa_name               VARCHAR(100),
    location_id             INT,
    location                VARCHAR(100),
    longitude               DOUBLE PRECISION,
    latitude                DOUBLE PRECISION,
    police_officer_strength INT,
    police_staff_strength   INT,
    pcso_strength           INT,
    crime_type_id           INT,
    crime_type              VARCHAR(100),
    number_of_crime         INT,
    CONSTRAINT pk_fact_crime_num PRIMARY KEY (date_id, lsoa_id, location_id, crime_type_id),
    CONSTRAINT fk_fact_crime_num_date
        FOREIGN KEY (date_id) REFERENCES dim_date (date_id),
    CONSTRAINT fk_fact_crime_num_lsoa
        FOREIGN KEY (lsoa_id) REFERENCES dim_lsoaname (lsoa_id),
    CONSTRAINT fk_fact_crime_num_location
        FOREIGN KEY (location_id) REFERENCES dim_location (location_id),
    CONSTRAINT fk_fact_crime_num_crime_type
        FOREIGN KEY (crime_type_id) REFERENCES dim_crime_type (crime_type_id)
);

INSERT INTO fact_crime_num (
    date_id,
    year,
    month_number,
    lsoa_id,
    lsoa_name,
    location_id,
    location,
    longitude,
    latitude,
    police_officer_strength,
    police_staff_strength,
    pcso_strength,
    crime_type_id,
    crime_type,
    number_of_crime
)
SELECT
    d.date_id,
    EXTRACT(YEAR FROM cd.crime_date)::INT  AS year,
    EXTRACT(MONTH FROM cd.crime_date)::INT AS month_number,
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    cd.police_officer_strength,
    cd.police_staff_strength,
    cd.pcso_strength,
    ct.crime_type_id,
    cd.crime_type,
    COUNT(*) AS number_of_crime
FROM crime_df cd
JOIN dim_date      d   ON cd.crime_date = d.full_date
JOIN dim_crime_type ct ON cd.crime_type  = ct.crime_type
JOIN dim_lsoaname   l  ON cd.lsoa_name   = l.lsoa_name
JOIN dim_location   loc ON cd.location   = loc.location
GROUP BY
    d.date_id,
    EXTRACT(YEAR FROM cd.crime_date),
    EXTRACT(MONTH FROM cd.crime_date),
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    cd.police_officer_strength,
    cd.police_staff_strength,
    cd.pcso_strength,
    ct.crime_type_id,
    cd.crime_type;


## fact_resolution table

CREATE TABLE fact_resolution (
    date_id                INT,
    year                   INT,
    month_number           INT,
    crime_type_id          INT,
    crime_type             VARCHAR(100),
    lsoa_id                INT,
    lsoa_name              VARCHAR(100),
    location_id            INT,
    location               VARCHAR(100),
    longitude              DOUBLE PRECISION,
    latitude               DOUBLE PRECISION,
    police_officer_strength INT,
    police_staff_strength   INT,
    pcso_strength           INT,
    outcome_id             INT,
    last_outcome_category  VARCHAR(200),
    number_of_resolution   INT,
    CONSTRAINT fk_fact_res_date
        FOREIGN KEY (date_id) REFERENCES dim_date (date_id),
    CONSTRAINT fk_fact_res_crime_type
        FOREIGN KEY (crime_type_id) REFERENCES dim_crime_type (crime_type_id),
    CONSTRAINT fk_fact_res_lsoa
        FOREIGN KEY (lsoa_id) REFERENCES dim_lsoaname (lsoa_id),
    CONSTRAINT fk_fact_res_location
        FOREIGN KEY (location_id) REFERENCES dim_location (location_id),
    CONSTRAINT fk_fact_res_outcome
        FOREIGN KEY (outcome_id) REFERENCES dim_outcome (outcome_id)
);

INSERT INTO fact_resolution (
    date_id,
    year,
    month_number,
    crime_type_id,
    crime_type,
    lsoa_id,
    lsoa_name,
    location_id,
    location,
    longitude,
    latitude,
    police_officer_strength,
    police_staff_strength,
    pcso_strength,
    outcome_id,
    last_outcome_category,
    number_of_resolution
)
SELECT
    d.date_id,
    EXTRACT(YEAR FROM cd.crime_date)::INT  AS year,
    EXTRACT(MONTH FROM cd.crime_date)::INT AS month_number,
    ct.crime_type_id,
    cd.crime_type,
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    cd.police_officer_strength,
    cd.police_staff_strength,
    cd.pcso_strength,
    o.outcome_id,
    cd.last_outcome_category,
    COUNT(*) AS number_of_resolution
FROM crime_df cd
JOIN dim_date      d   ON cd.crime_date            = d.full_date
JOIN dim_crime_type ct ON cd.crime_type            = ct.crime_type
JOIN dim_lsoaname   l  ON cd.lsoa_name             = l.lsoa_name
JOIN dim_location   loc ON cd.location             = loc.location
JOIN dim_outcome    o  ON cd.last_outcome_category = o.last_outcome_category
GROUP BY
    d.date_id,
    EXTRACT(YEAR FROM cd.crime_date),
    EXTRACT(MONTH FROM cd.crime_date),
    ct.crime_type_id,
    cd.crime_type,
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    cd.police_officer_strength,
    cd.police_staff_strength,
    cd.pcso_strength,
    o.outcome_id,
    cd.last_outcome_category;


## fact_crime_occurring_time table

CREATE TABLE fact_crime_occurring_time (
    date_id                  INT,
    year                     INT,
    month_number             INT,
    crime_type_id            INT,
    crime_type               VARCHAR(100),
    lsoa_id                  INT,
    lsoa_name                VARCHAR(100),
    location_id              INT,
    location                 VARCHAR(100),
    longitude                DOUBLE PRECISION,
    latitude                 DOUBLE PRECISION,
    day_of_week              VARCHAR(10),
    number_of_crime_occurring INT,
    CONSTRAINT fk_fact_cot_date
        FOREIGN KEY (date_id) REFERENCES dim_date (date_id),
    CONSTRAINT fk_fact_cot_crime_type
        FOREIGN KEY (crime_type_id) REFERENCES dim_crime_type (crime_type_id),
    CONSTRAINT fk_fact_cot_lsoa
        FOREIGN KEY (lsoa_id) REFERENCES dim_lsoaname (lsoa_id),
    CONSTRAINT fk_fact_cot_location
        FOREIGN KEY (location_id) REFERENCES dim_location (location_id)
);

INSERT INTO fact_crime_occurring_time (
    date_id,
    year,
    month_number,
    crime_type_id,
    crime_type,
    lsoa_id,
    lsoa_name,
    location_id,
    location,
    longitude,
    latitude,
    day_of_week,
    number_of_crime_occurring
)
SELECT
    d.date_id,
    d.year,
    d.month_number,
    ct.crime_type_id,
    cd.crime_type,
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    d.day_of_week,
    COUNT(*) AS number_of_crime_occurring
FROM crime_df cd
JOIN dim_date      d   ON cd.crime_date = d.full_date
JOIN dim_crime_type ct ON cd.crime_type = ct.crime_type
JOIN dim_lsoaname   l  ON cd.lsoa_name  = l.lsoa_name
JOIN dim_location   loc ON cd.location  = loc.location
GROUP BY
    d.date_id,
    d.year,
    d.month_number,
    ct.crime_type_id,
    cd.crime_type,
    l.lsoa_id,
    cd.lsoa_name,
    loc.location_id,
    cd.location,
    cd.longitude,
    cd.latitude,
    d.day_of_week;













